# Default values for kraken
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# ============================================
# Global Settings
# ============================================
global:
  # Image registry override (leave empty to use default)
  imageRegistry: ""
  # Image pull secrets for private registries
  imagePullSecrets: []

# ============================================
# Backend Configuration
# ============================================
backend:
  # Number of backend replicas
  replicaCount: 2

  image:
    repository: ghcr.io/user/kraken-backend
    pullPolicy: Always
    tag: "latest"

  # Service configuration
  service:
    type: ClusterIP
    port: 3000
    annotations: {}

  # Resource limits and requests
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi

  # Horizontal Pod Autoscaler
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Liveness and readiness probes
  livenessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 40
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Node selector for pod assignment
  nodeSelector: {}

  # Tolerations for pod assignment
  tolerations: []

  # Affinity for pod assignment
  affinity: {}

  # Pod annotations
  podAnnotations: {}

  # Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1001
    fsGroup: 1001

  # Container security context
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false

# ============================================
# Frontend Configuration
# ============================================
frontend:
  # Number of frontend replicas
  replicaCount: 2

  image:
    repository: ghcr.io/user/kraken-frontend
    pullPolicy: IfNotPresent
    tag: "latest"

  # Service configuration
  service:
    type: ClusterIP
    port: 5173
    annotations: {}

  # Resource limits and requests
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Horizontal Pod Autoscaler
  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70

  # Liveness and readiness probes
  livenessProbe:
    httpGet:
      path: /health
      port: 5173
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 5

  readinessProbe:
    httpGet:
      path: /health
      port: 5173
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5

  # Environment variables for nginx
  env:
    # Backend URL (internal service URL)
    backendUrl: "http://kraken-backend:3000"

  # Extra environment variables for the frontend container
  # These are injected at runtime (useful for telemetry, feature flags, etc.)
  # Example:
  #   extraEnv:
  #     - name: VITE_TELEMETRY_ENDPOINT
  #       value: "https://openobserve.example.com"
  #     - name: VITE_TELEMETRY_CLIENT_TOKEN
  #       valueFrom:
  #         secretKeyRef:
  #           name: telemetry-secrets
  #           key: client-token
  extraEnv: []

  # Node selector for pod assignment
  nodeSelector: {}

  # Tolerations for pod assignment
  tolerations: []

  # Affinity for pod assignment
  affinity: {}

  # Pod annotations
  podAnnotations: {}

  # Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101  # nginx user
    fsGroup: 101

  # Container security context
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false

# ============================================
# Ingress Configuration
# ============================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    # WebSocket support - Long timeouts for persistent connections
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    # File upload size
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    # WebSocket upgrade headers for Socket.IO and LiveKit
    nginx.ingress.kubernetes.io/websocket-services: "kraken-backend"
    # Cookie-based sticky sessions (required for multi-replica Socket.IO)
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "kraken-affinity"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "3600"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    # Additional annotations for your use case
    # nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

  hosts:
    - host: kraken.local
      paths:
        - path: /
          pathType: Prefix
          service: frontend
        - path: /api
          pathType: Prefix
          service: backend
        - path: /socket.io
          pathType: Prefix
          service: backend

  # TLS configuration
  tls:
    # Options: "none", "cert-manager", "manual"
    mode: "none"

    # For cert-manager mode
    certManager:
      enabled: false
      issuer: "letsencrypt-prod"
      issuerKind: "ClusterIssuer"

    # For manual mode - reference to existing secret
    secretName: ""

# ============================================
# MongoDB Configuration
# ============================================
mongodb:
  # Set to true to deploy MongoDB as part of this chart
  # Set to false to use external MongoDB
  bundled: true

  # Architecture: standalone or replicaset
  architecture: replicaset

  # Replica set configuration (required for Kraken's change streams)
  replicaCount: 3
  replicaSetName: rs0

  # Authentication
  auth:
    enabled: true
    rootUser: root
    rootPassword: "changeme-root-password"
    username: kraken
    password: "changeme-kraken-password"
    database: kraken

  # Persistence
  persistence:
    enabled: true
    size: 20Gi
    # storageClass: ""

  # Resources
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi

  # External MongoDB configuration (when bundled: false)
  external:
    # Full MongoDB connection string
    uri: "mongodb://user:password@mongo.example.com:27017/kraken?replicaSet=rs0"

# ============================================
# Redis Configuration
# ============================================
redis:
  # Set to true to deploy Redis as part of this chart
  # Set to false to use external Redis
  bundled: true

  # Architecture: standalone or replication
  architecture: standalone

  # Authentication
  auth:
    enabled: true
    password: "changeme-redis-password"

  # Persistence
  master:
    persistence:
      enabled: true
      size: 8Gi
      # storageClass: ""

  # Resources
  master:
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

  # External Redis configuration (when bundled: false)
  external:
    host: "redis.example.com"
    port: 6379
    password: ""

# ============================================
# LiveKit Configuration (External Only)
# ============================================
livekit:
  # LiveKit server URL (WebSocket endpoint)
  url: "wss://livekit.example.com"

  # LiveKit API credentials
  apiKey: "your-livekit-api-key"
  apiSecret: "your-livekit-api-secret"

  # Webhook secret for verifying LiveKit webhook signatures
  # Generate with: openssl rand -hex 32
  webhookSecret: "your-livekit-webhook-secret"

# ============================================
# Application Secrets
# ============================================
secrets:
  # JWT secrets for authentication
  jwtSecret: "CHANGE-ME-long-random-secret-for-jwt-signing"
  jwtRefreshSecret: "CHANGE-ME-different-long-random-secret-for-refresh-tokens"

  # Create secrets from existing Kubernetes secret
  # If true, the above values are ignored and you must create a secret manually
  existingSecret: ""

# ============================================
# Service Account
# ============================================
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# ============================================
# Pod Disruption Budget
# ============================================
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# ============================================
# Network Policies
# ============================================
networkPolicy:
  enabled: false
  policyTypes:
    - Ingress
    - Egress

# ============================================
# File Storage Configuration
# ============================================
fileStorage:
  # Enable persistent file storage for uploads
  # Set to false to use ephemeral storage (files lost on pod restart)
  enabled: false

  # Storage size
  size: 100Gi

  # Storage class name (leave empty for no storage class)
  # If using dynamic provisioning, specify your storage class here
  storageClassName: ""

  # NFS-specific configuration
  # To use NFS, set nfs.enabled: true and provide your NFS server details
  nfs:
    enabled: false
    # NFS server IP or hostname (override with your NFS server)
    server: "nfs-server.example.com"
    # NFS export path (override with your NFS export path)
    path: "/exports/kraken-uploads"

  # Mount options for NFS volumes (optional)
  # If not specified, default NFSv4.1 resilient options are used
  # Set to empty array [] to use NFSv3 defaults without any custom options
  # Example custom options: ["nfsvers=4.1", "hard", "tcp"]
  # mountOptions: []

# ============================================
# Replay Segments Storage Configuration
# ============================================
# Storage for LiveKit egress replay segments
# This directory is shared between LiveKit egress pods and the backend
replayStorage:
  # Enable replay segments storage
  # Set to false to disable replay buffer features
  enabled: false

  # Storage size for replay segments
  size: 50Gi

  # Mount path in the backend container
  # This should match the REPLAY_SEGMENTS_PATH environment variable
  mountPath: "/app/replay-segments"

  # NFS-specific configuration for shared storage
  # Required when using multiple backend replicas or external LiveKit egress
  nfs:
    enabled: false
    # NFS server IP or hostname
    server: "nfs-server.example.com"
    # NFS export path for replay segments
    path: "/exports/kraken-replay-segments"
