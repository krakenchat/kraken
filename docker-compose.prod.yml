# Production Docker Compose for Kraken
#
# Usage:
#   1. Copy backend/env.sample to .env.prod â€” fill in JWT secrets, LiveKit config, etc.
#   2. Add these extra vars to .env.prod for the database and cache:
#        MONGO_PASSWORD=<strong-password>
#        REDIS_PASSWORD=<strong-password>
#   3. docker compose -f docker-compose.prod.yml --env-file .env.prod up -d
#
# See https://docs.krakenchat.app/installation/docker-compose/ for the full guide.
# For Kubernetes deployments, see the helm/ directory.

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.prod
    env_file:
      - .env.prod
    environment:
      - NODE_ENV=production
      - MONGODB_URL=mongodb://${MONGO_USERNAME:-kraken}:${MONGO_PASSWORD:?MONGO_PASSWORD required}@mongo:27017/kraken?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority&directConnection=true
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD:?REDIS_PASSWORD required}
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.prod
      args:
        VITE_API_URL: /api
    environment:
      - BACKEND_URL=http://backend:3000
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5173/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3

  mongo:
    image: mongo:7.0
    command: >
      bash -c '
        # Generate keyfile for replica set authentication if it doesn't exist
        if [ ! -f /data/keyfile ]; then
          openssl rand -base64 756 > /data/keyfile
          chmod 400 /data/keyfile
          chown 999:999 /data/keyfile
        fi
        exec mongod --replSet rs0 --bind_ip_all --port 27017 --keyFile /data/keyfile --auth
      '
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-kraken}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:?MONGO_PASSWORD required}
    healthcheck:
      test: >
        echo "try { rs.status() } catch (err) { rs.initiate({_id:'rs0',members:[{_id:0,host:'mongo:27017'}]}) }" |
        mongosh --port 27017 -u ${MONGO_USERNAME:-kraken} -p ${MONGO_PASSWORD} --authenticationDatabase admin --quiet
      interval: 10s
      timeout: 30s
      start_period: 30s
      retries: 10
    volumes:
      - mongodata:/data/db
      - mongodb_config:/data/configdb
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD:?REDIS_PASSWORD required}", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 10s
      retries: 10
    volumes:
      - redisdata:/data
    restart: unless-stopped

volumes:
  mongodata:
  mongodb_config:
  redisdata:
